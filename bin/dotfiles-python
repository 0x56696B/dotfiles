#!/usr/bin/env python3

import os
from os.path import split
import sys
import argparse
import subprocess

from helper_scripts import get_value_from_encrypted_file

# Define paths and default values
DOTFILES = os.path.dirname(os.path.dirname(os.path.realpath(__file__)))
DOTFILES_LOG = os.path.join(DOTFILES, "dotfiles.log")
VAULT_SECRET_FILE = os.path.join(DOTFILES, "vault.secret")
INVENTORY_FILE = os.path.join(DOTFILES, "inventory/hosts.yml")
HOSTS = ""
ROLES = ""
LIST_HOSTS = False
LIST_ROLES = False
DEBUG = False

# Function to display usage (help) message
def usage():
    print("Usage: {} [options]".format(sys.argv[0]))
    print("  -i, --inventory file      Specify the Ansible inventory file. Defaults to inventory/hosts.yml.")
    print("  -r, --roles roles         Specify comma separated roles to run, such as \"neovim,zsh\", etc.")
    print("  -m, --machines hosts      Specify single host, such as \"local\", or multiples. Defaults to \"all\".")
    print("  -lh, --list-hosts         List Hosts. Used for rerun with targeting and because inventory is encrypted.")
    print("  -h, --help                Display this help message.")
    print("  --debug                   Debug issues")
    sys.exit(1)

# Parse command line arguments
parser = argparse.ArgumentParser(description="Run Ansible playbooks with custom options.")

parser.add_argument("-i", "--inventory", help="Specify the Ansible inventory file.", default=INVENTORY_FILE)
parser.add_argument("-m", "--machines", help="Specify hosts to target.", default="")
parser.add_argument("-r", "--roles", help="Specify comma-separated roles to run.", default="")
parser.add_argument("-lh", "--list-hosts", help="List Hosts.", action="store_true")
parser.add_argument("-lr", "--list-roles", help="List Roles.", action="store_true")
parser.add_argument("--debug", help="Debug issues", action="store_true")

args = parser.parse_args()

INVENTORY_FILE = args.inventory
HOSTS = args.machines
ROLES = args.roles
LIST_HOSTS = args.list_hosts
LIST_ROLES = args.list_roles
DEBUG = args.debug

# Initial ansible command
ANSIBLE_COMMAND = f"ansible-playbook {os.path.join(DOTFILES, 'main.yml')} -i {INVENTORY_FILE}"

# Check if become password is present in the inventory file for the specified hosts
BECOME_PASSWORD_PRESENT = 0
if HOSTS:
    vault_file_present = os.path.isfile(VAULT_SECRET_FILE)

    for host in HOSTS.split(","):
        if host == "all":
            break

        inventory_file_host = f"inventory/host_vars/{host}.yml";
        key = "ansible_become_password"

        pass_value = get_value_from_encrypted_file(inventory_file_host, key, VAULT_SECRET_FILE, vault_file_present)
        if pass_value == "":
            BECOME_PASSWORD_PRESENT = 0
            break

        BECOME_PASSWORD_PRESENT = 1

# Handle become password prompt conditionally
if BECOME_PASSWORD_PRESENT != 1:
    if sys.platform == "darwin" and "system-update" in ROLES.split(","):
        ANSIBLE_COMMAND += " --ask-become-pass"
    if sys.platform == "linux":
        ANSIBLE_COMMAND += " --ask-become-pass"

# Use Vault file, if present
if os.path.isfile(VAULT_SECRET_FILE):
    ANSIBLE_COMMAND += f" --vault-password-file {VAULT_SECRET_FILE}"
else:
    ANSIBLE_COMMAND += " --ask-vault-password"

# List roles
if LIST_ROLES:
    ANSIBLE_COMMAND += " --list-roles"
    os.system("ls -1 roles")
    sys.exit(0)

# List hosts in inventory file (useful, because they are encrypted)
if LIST_HOSTS:
    ANSIBLE_COMMAND += " --list-hosts"
    subprocess.run(ANSIBLE_COMMAND, shell=True)
    sys.exit(0)

# Specify for which hosts/groups/machines to execute (in inventory)
if HOSTS:
    ANSIBLE_COMMAND += f" -l {HOSTS}"
else:
    ANSIBLE_COMMAND += " -l all"

# Specify which roles to run
if ROLES:
    ANSIBLE_COMMAND += f" --tags {ROLES}"
else:
    ANSIBLE_COMMAND += " --tags \"all\""

# Debug issues/Run with verbosity
if DEBUG:
    ANSIBLE_COMMAND += " -vvv"

# Load and setup ansible (assuming this is a source command for a shell script)
setup_script = os.path.join(DOTFILES, "bin/setup.sh")
subprocess.run(f"source {setup_script} && load_setup", shell=True)

# Execute the ansible command
print(f"Executing command: {ANSIBLE_COMMAND}")
subprocess.run(ANSIBLE_COMMAND, shell=True)
